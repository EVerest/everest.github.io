<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>8. Pionix BelayBox &#8212; EVerest  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxdoc.css" />
    <link rel="stylesheet" type="text/css" href="../_static/contentui.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/contentui.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9. Snapshot" href="../appendix/02_snapshot.html" />
    <link rel="prev" title="7.8. Sphinx style guide" href="../tutorials/sphinx_style_guide.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../appendix/02_snapshot.html" title="9. Snapshot"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../tutorials/sphinx_style_guide.html" title="7.8. Sphinx style guide"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">EVerest  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">8. </span>Pionix BelayBox</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="pionix-belaybox">
<h1><span class="section-number">8. </span>Pionix BelayBox<a class="headerlink" href="#pionix-belaybox" title="Permalink to this heading">¶</a></h1>
<section id="introduction">
<h2><span class="section-number">8.1. </span>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">¶</a></h2>
<p>The BelayBox is a reference platform specifically designed for development and
testing of the open source software EVerest.</p>
<p>Inside the box, a Raspberry Pi is built in and we are officially part of the
“Powered by Raspberry Pi” scheme:</p>
<a class="reference internal image-reference" href="../_images/powered-by-pi.png"><img alt="Logo Powered by Raspberry Pi for Charging Development Kit BelayBox" class="align-center" src="../_images/powered-by-pi.png" style="width: 300px;" /></a>
<p>BelayBox can be utilized by individuals, research facilities and companies
alike to</p>
<ul class="simple">
<li><p>parallelize HW and SW developments for new charger projects,</p></li>
<li><p>explore new charging algorithms without the need do all the groundwork,</p></li>
<li><p>rapid integration of EV charging with other applications</p></li>
</ul>
<p>and anything else you want to quickly do without building your own EVerest
compatible charger first.</p>
<p>The BelayBox is not meant to be used for private usage or outdoor charging,</p>
<section id="the-belaybox-hardware">
<h3><span class="section-number">8.1.1. </span>The BelayBox hardware<a class="headerlink" href="#the-belaybox-hardware" title="Permalink to this heading">¶</a></h3>
<p>Inside, the BelayBox consists mainly of the Yeti board - an AC charger for
electric vehicles (EV) supporting IEC-61851-1 and SAE J1772 - and the Yak
board, which is a high-level control board for EV charging stations supporting
ISO 15118-2 (with ISO 15118-20 on its way) and DIN SPEC70121.</p>
<p>As both Yeti and Yak Board are also released as Open Hardware under CERN Open
Hardware Licence Version 2 (Permissive), we are very happy to point you to the
schematics and design files and also the firmware:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/PionixPublic/reference-hardware">Yeti and Yak Hardware Reference Design</a></p></li>
<li><p><a class="reference external" href="https://github.com/PionixPublic/yeti-firmware">Yeti Firmware</a></p></li>
</ul>
<p>For more information about vendors working with EVerest,
contact us via
the <a class="reference external" href="https://lists.lfenergy.org/g/everest">EVerest mailing list</a>.</p>
</section>
</section>
<section id="setting-up-hardware-and-software">
<h2><span class="section-number">8.2. </span>Setting up Hardware and Software<a class="headerlink" href="#setting-up-hardware-and-software" title="Permalink to this heading">¶</a></h2>
<section id="assembling-the-yak-board">
<h3><span class="section-number">8.2.1. </span>Assembling the Yak Board<a class="headerlink" href="#assembling-the-yak-board" title="Permalink to this heading">¶</a></h3>
<p>Starting assembling the Yak Board, you should have the following parts
available:</p>
<img alt="../_images/yak-assembly-1-overview.jpg" src="../_images/yak-assembly-1-overview.jpg" />
<p>And you will need the following tools:</p>
<ul class="simple">
<li><p>ESD safe environment, e.g. ESD wrist band</p></li>
<li><p>ESD underlay mat</p></li>
<li><p>Linux host system, Ubuntu &gt;18 recommended</p></li>
<li><p>1x Micro USB cable</p></li>
<li><p>12V DC power supply with minimum 30W to connect to “12V IN” pins on
Yak board. A lab power supply is sufficient.</p></li>
</ul>
<p>Needed software:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/raspberrypi/usbboot/blob/master/Readme.md#building">Raspberry PI USB Boot</a></p></li>
<li><p><a class="reference external" href="https://www.balena.io/etcher">balenaEtcher</a>
(“dd” also works but is dangerous to use and much slower)</p></li>
<li><p>Internet access from host system</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Before working with any open PCB make sure to work in an ESD safe
environment using ESD safe equipment only.</p>
</div>
<p>Glue on the heatsinks as shown in the following image using the double
sided tape that comes with the heatsinks. Plug in the small clips into
the mounting holes of the CM4 board as shown.</p>
<img alt="../_images/yak-assembly-2.jpg" src="../_images/yak-assembly-2.jpg" />
<p>Turn around the CM4 and put on the gray spacers as shown here:</p>
<img alt="../_images/yak-assembly-3.jpg" src="../_images/yak-assembly-3.jpg" />
<p>Plug the CM4 board in both connectors and make sure the clips go all the way
through the Yak board and hold the CM4 securely without any gaps between the
spacers and both boards. Make sure to remove the metal part (if there is one)
out of the board-to-board connector as shown in the upper left corner in the
following image:</p>
<img alt="../_images/yak-assembly-4.jpg" src="../_images/yak-assembly-4.jpg" />
<p>This is how it looks from the top side:</p>
<img alt="../_images/yak-assembly-5.jpg" src="../_images/yak-assembly-5.jpg" />
<p>Now place the small black jumper onto the “BOOT” pins as shown above. This
is needed to be able to mount the emmC flash to the host system.</p>
</section>
<section id="flashing-the-yak-board">
<h3><span class="section-number">8.2.2. </span>Flashing the Yak Board<a class="headerlink" href="#flashing-the-yak-board" title="Permalink to this heading">¶</a></h3>
<img alt="../_images/yak-assembly-6.jpg" src="../_images/yak-assembly-6.jpg" />
<p>Plug in a micro usb cable to the “J1” USB socket and plug the other end in the
linux host system.</p>
<p>Download the image to be flashed to the host system from here:
<a class="reference external" href="https://pionix-update.de/belayboxr1/stable/current.img.gz">https://pionix-update.de/belayboxr1/stable/current.img.gz</a> e.g. with the
command:</p>
<p><code class="docutils literal notranslate"><span class="pre">wget</span> <span class="pre">https://pionix-update.de/belayboxr1/stable/current.img.gz</span></code></p>
<p>In order to flash the emmC, please install “rpiboot” as described in here:</p>
<p><a class="reference external" href="https://github.com/raspberrypi/usbboot/blob/master/Readme.md#building">https://github.com/raspberrypi/usbboot/blob/master/Readme.md#building</a></p>
<p>After successful install, execute</p>
<p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">./rpiboot</span></code></p>
<p>Power on the Yak board using the 12V power source on the “12V IN” pins.
The red LED should light up.</p>
<p>Once <em>rpiboot</em> has detected the board, a green LED should light up on the
board.</p>
<img alt="../_images/yak-assembly-7.png" src="../_images/yak-assembly-7.png" />
<p>Start the tool <em>balenaEtcher</em>. You should see that <em>balenaEtcher</em> has
automatically detected the Compute Module. If not, select the correct drive.
Click “Flash from file” and select the extracted file “current.img.gz”.
<em>balenaEtcher</em> will automatically unzip the file.</p>
<img alt="../_images/yak-assembly-8.png" src="../_images/yak-assembly-8.png" />
<p>Click “Flash” and wait for the flashing and validation to finish. This can
take up to 1.5h. Take a walk and/or treat yourself to a coffee.</p>
<p>The emmC is unfortunately a slow device to flash.</p>
<p>After <em>balenaEtcher</em> reports a successful flash, power down the Yak board and
remove the jumper from the “BOOT” pins and the USB cable from the board.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Make sure to connect the WiFi antenna to the CM4 after flashing. The image
activates the external antenna support. Running a flashed Yak without the
WiFi antenna mounted will result in damage of the WiFi chip.</p>
</div>
<img alt="../_images/yak-assembly-9.jpg" src="../_images/yak-assembly-9.jpg" />
<p>The Yak board is now ready to boot.</p>
</section>
<section id="assembling-the-yeti-board">
<h3><span class="section-number">8.2.3. </span>Assembling the Yeti Board<a class="headerlink" href="#assembling-the-yeti-board" title="Permalink to this heading">¶</a></h3>
<p>Here’s what you should have:</p>
<img alt="../_images/yeti-assembly-1-overview.jpg" src="../_images/yeti-assembly-1-overview.jpg" />
<p>Tools needed:</p>
<ul class="simple">
<li><p>ESD safe environment, e.g. ESD wrist band</p></li>
<li><p>ESD underlay mat</p></li>
</ul>
<p>Clip on the touch protection cage and make sure all clips are correctly seated
as shown here:</p>
<img alt="../_images/yeti-assembly-2.jpg" src="../_images/yeti-assembly-2.jpg" />
<p>Clip in the smaller part of the touch protection and make sure all clips are
correctly seated as shown here:</p>
<img alt="../_images/yeti-assembly-3.jpg" src="../_images/yeti-assembly-3.jpg" />
<p>Clip in the bigger part of the touch protection and make sure all clips are
correctly seated as shown in the following image:</p>
<img alt="../_images/yeti-assembly-4.jpg" src="../_images/yeti-assembly-4.jpg" />
<p>Your mission can be seen as accomplished if your Yeti looks like that:</p>
<img alt="../_images/yeti-assembly-5.jpg" src="../_images/yeti-assembly-5.jpg" />
</section>
<section id="preparing-the-cable-set">
<h3><span class="section-number">8.2.4. </span>Preparing the cable set<a class="headerlink" href="#preparing-the-cable-set" title="Permalink to this heading">¶</a></h3>
<p>That’s how we start:</p>
<img alt="../_images/cable-set-1-overview.jpg" src="../_images/cable-set-1-overview.jpg" />
<p>The <strong>10-position cable between Yeti and Yak</strong> is mandatory to connect Yak to
Yeti and to power the Yak board from the Yeti power supply.</p>
<img alt="../_images/cable-set-2.jpg" src="../_images/cable-set-2.jpg" />
<p>Plug in one of the crimped cables with one end into the 10-position plug. Make
sure to plug in the crimp in the exact same orientation as shown in the
picture above. Be aware that the crimps cannot be unplugged again from the
10-position plug. Make sure you plug in the crimps in the correct positions
before actually plugging them in.</p>
<p>Plug in the other crimped end of the cable into the second plug. It is very
important to plug in the crimps in the shown “1:1” fashion. Doing otherwise
will permanently damage the Yak and/or Yeti board.</p>
<img alt="../_images/cable-set-3.jpg" src="../_images/cable-set-3.jpg" />
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Be aware that the crimps cannot be unplugged again from the 10 position
plug. Make sure you plug in the crimps in the correct positions before
actually plugging them in.</p>
</div>
<p>Continue with plugging in all ten cables one after the other as there is less
chance of getting it wrong this way.</p>
<p>This is how the cable looks when assembly is done:</p>
<img alt="../_images/cable-set-4.jpg" src="../_images/cable-set-4.jpg" />
<p>Let’s continue with the <strong>6-position CAN + RS485 cable</strong>.</p>
<img alt="../_images/cable-set-5.jpg" src="../_images/cable-set-5.jpg" />
<p>Plug in a crimped cable with one end into the 6-position plug.
Make sure to plug in the crimp in the exact same orientation as shown in the
picture above. Continue with plugging in all needed cables.</p>
<p>Be aware that these cables have unisolated, open ends. In case you use the
6-position cable for e.g. using the CAN bus, make sure all other not used
cables are isolated to prevent damage to the Yak board.</p>
<p>This is how the assembled cable looks like:</p>
<img alt="../_images/cable-set-6.jpg" src="../_images/cable-set-6.jpg" />
<p>This is the pin description of the Yak board’s 4-, 6- and 10-position sockets:</p>
<img alt="../_images/cable-set-7.png" src="../_images/cable-set-7.png" />
</section>
<section id="final-yak-yeti-cable-setup">
<h3><span class="section-number">8.2.5. </span>Final Yak-Yeti-Cable-Setup<a class="headerlink" href="#final-yak-yeti-cable-setup" title="Permalink to this heading">¶</a></h3>
<p>Tools needed:</p>
<ul class="simple">
<li><p>ESD safe environment, e.g. ESD wrist band</p></li>
<li><p>ESD underlay mat</p></li>
<li><p>Preassembled Yak, Yeti kits and cable-set as shown in sections above</p></li>
</ul>
<img alt="../_images/final-assembly.jpg" src="../_images/final-assembly.jpg" />
<p>Plug in the 10-pin cable into the corresponding sockets on both ends.
Plug in the 4-pin RFID/NFC reader cable.
The assembly of Yak, Yet kit and cable set is completed.</p>
<p>When using the assembly in a “desk” environment, it is recommended to apply
power through the 12V DC barrel connector shown in the upper right corner of
the Yeti board in the image above. Make sure the WiFi antenna does not touch
any other open PCB parts to prevent damage to the boards.</p>
</section>
<section id="raspbian">
<h3><span class="section-number">8.2.6. </span>Raspbian<a class="headerlink" href="#raspbian" title="Permalink to this heading">¶</a></h3>
<p>BelayBox uses Raspian (a debian flavour for the Raspberry Pi) as a main
operating system for development purposes.
For deployment on real products you should consider using Yocto or similar
instead.</p>
<p>For further information like the partitioning scheme and updating Raspbian,
section <a class="reference internal" href="#belaybox-furtherinfo"><span class="std std-ref">BelayBox Further Information</span></a>.</p>
</section>
<section id="everest">
<h3><span class="section-number">8.2.7. </span>EVerest<a class="headerlink" href="#everest" title="Permalink to this heading">¶</a></h3>
<p>EVerest is the charging software on the BelayBox that controls charging,
cloud access, authorization, energy management, the display app etc.</p>
<section id="integration-into-raspbian">
<h4><span class="section-number">8.2.7.1. </span>Integration into Raspbian<a class="headerlink" href="#integration-into-raspbian" title="Permalink to this heading">¶</a></h4>
<p>EVerest is installed under <code class="docutils literal notranslate"><span class="pre">/opt/everest</span></code>. Since this folder is in the
root partition it is also updated with the regular online update.</p>
<p>The systemd service <code class="docutils literal notranslate"><span class="pre">everest.service</span></code> starts EVerest at boot if no custom
everest installation is found under <code class="docutils literal notranslate"><span class="pre">/mnt/user_data/opt/everest</span></code>.</p>
<dl class="simple">
<dt>The systemd service <code class="docutils literal notranslate"><span class="pre">everest-dev.service</span></code> starts EVerest at boot from</dt><dd><p><code class="docutils literal notranslate"><span class="pre">/mnt/user_data/opt/everest</span></code> if that exists.</p>
</dd>
</dl>
<p>The systemd service <code class="docutils literal notranslate"><span class="pre">display-app.service</span></code> starts the flutter based
display application.</p>
</section>
<section id="update-yeti-s-microcontroller-firmware">
<h4><span class="section-number">8.2.7.2. </span>Update Yeti’s microcontroller firmware<a class="headerlink" href="#update-yeti-s-microcontroller-firmware" title="Permalink to this heading">¶</a></h4>
<p>The Yeti Power Board is controlled by an STM32 microcontroller that is
responsible for the lowest level state machine and all electrical safety.
In the future updates will be installed automatically. For now they can be
installed manually.</p>
<p>The firmware has been open sourced, see <a class="reference external" href="https://github.com/PionixPublic/yeti-firmware">Yeti Firmware</a></p>
<p>In your normal workflow, updating this firmware is not needed.</p>
<p>The microcontroller is not protected (remember this is a dev kit and not
a real product). You can use the update tool that comes with the Yeti
EVerest driver module:</p>
<p><code class="docutils literal notranslate"><span class="pre">/opt/everest/bin/yeti_fwupdate</span> <span class="pre">/dev/serial0</span> <span class="pre">new-firmware.bin</span></code></p>
<p>This will reboot the microcontroller in firmware update ROM bootloader and
uses stm32flash tool to upload the new firmware.</p>
</section>
</section>
</section>
<section id="developing-with-everest-and-belaybox">
<h2><span class="section-number">8.3. </span>Developing with EVerest and BelayBox<a class="headerlink" href="#developing-with-everest-and-belaybox" title="Permalink to this heading">¶</a></h2>
<p>You can use make or ninja with cmake. The examples here are given with make.</p>
<section id="setup-cross-compile-environment">
<h3><span class="section-number">8.3.1. </span>Setup cross compile environment<a class="headerlink" href="#setup-cross-compile-environment" title="Permalink to this heading">¶</a></h3>
<p>First, make sure you have successfully built EVerest natively on your laptop
as described here: <a class="reference external" href="https://github.com/EVerest/everest-core#everest-core">https://github.com/EVerest/everest-core#everest-core</a></p>
<p>Download and untar the bullseye-toolchain:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget<span class="w"> </span>http://build.pionix.de:8888/release/toolchains/bullseye-toolchain.tgz
tar<span class="w"> </span>xfz<span class="w"> </span>bullseye-toolchain.tgz
</pre></div>
</div>
<p>Change directory to everest-core in your workspace e.g.:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/checkout/everest-workspace/everest-core
</pre></div>
</div>
<p>Cross-compile by changing the given paths accordingly:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cmake<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-DCMAKE_TOOLCHAIN_FILE<span class="o">=</span>/full-path-to/bullseye-toolchain/toolchain.cmake<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-DCMAKE_INSTALL_PREFIX<span class="o">=</span>/mnt/user_data/opt/everest<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-S<span class="w"> </span>.<span class="w"> </span>-B<span class="w"> </span>build-cross
</pre></div>
</div>
<p>Now build EVerest with the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make<span class="w"> </span>-j<span class="k">$(</span>nproc<span class="k">)</span><span class="w"> </span>-C<span class="w"> </span>build-cross
make<span class="w"> </span>-j<span class="k">$(</span>nproc<span class="k">)</span><span class="w"> </span><span class="nv">DESTDIR</span><span class="o">=</span>./dist<span class="w"> </span>-C<span class="w"> </span>build-cross<span class="w"> </span>install
</pre></div>
</div>
<section id="deploy-a-custom-everest-on-belaybox">
<h4><span class="section-number">8.3.1.1. </span>Deploy a custom EVerest on BelayBox<a class="headerlink" href="#deploy-a-custom-everest-on-belaybox" title="Permalink to this heading">¶</a></h4>
<p>The binaries are now installed under <code class="docutils literal notranslate"><span class="pre">build-cross/dist</span></code>.
You can use <code class="docutils literal notranslate"><span class="pre">rsync</span></code> within the <code class="docutils literal notranslate"><span class="pre">build-cross</span></code> folder to copy the files to
BelayBox:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rsync<span class="w"> </span>-a<span class="w"> </span>build-cross/dist/mnt/user_data/opt/everest/*<span class="w"> </span>everest@the.ip.add.res:/mnt/user_data/opt/everest
</pre></div>
</div>
<p>The first time you need to create the folder <code class="docutils literal notranslate"><span class="pre">/mnt/user_data/opt/everest</span></code>
on the BelayBox before syncing
(<code class="docutils literal notranslate"><span class="pre">ssh</span> <span class="pre">everest&#64;the.ip.add.res</span> <span class="pre">mkdir</span> <span class="pre">-p</span> <span class="pre">/mnt/user_data/opt/everest</span></code>)</p>
<p>You can also copy to another folder on the BelayBox, but using
<code class="docutils literal notranslate"><span class="pre">/mnt/user_data/opt/everest</span></code> will make your new custom everest installation
auto start at boot (see <code class="docutils literal notranslate"><span class="pre">everest-dev.service</span></code>). This way you can have a
custom installation and still use the online updates for the base system.</p>
<p>If you do it for the first time, reboot BelayBox so that
<code class="docutils literal notranslate"><span class="pre">everest-dev.service</span></code> is used from now-on instead of <code class="docutils literal notranslate"><span class="pre">everest.service</span></code>.</p>
</section>
</section>
</section>
<section id="belaybox-further-information">
<span id="belaybox-furtherinfo"></span><h2><span class="section-number">8.4. </span>BelayBox Further Information<a class="headerlink" href="#belaybox-further-information" title="Permalink to this heading">¶</a></h2>
<section id="reference-cheat-sheet">
<h3><span class="section-number">8.4.1. </span>Reference Cheat Sheet<a class="headerlink" href="#reference-cheat-sheet" title="Permalink to this heading">¶</a></h3>
<ul>
<li><p>rw: make root partition read/writable</p></li>
<li><p>ro: make it read only again</p></li>
<li><p>/mnt/user_data/etc/wpa_supplicant/wpa_supplicant.conf: file containing wifi settings</p></li>
<li><p>/mnt/user_data/opt/everest/&lt;crosscompiled everest binaries&gt; force the use of custom everest build or config by automated start of <code class="docutils literal notranslate"><span class="pre">everest-dev.service</span></code> instead of <code class="docutils literal notranslate"><span class="pre">everest.service</span></code></p></li>
<li><p>/mnt/user_data/etc/update_channel contains either stable or unstable to define release channels</p></li>
<li><p>/mnt/user_data/etc/wireguard/wg0.conf for a wireguard VPN configuration</p></li>
<li><p>/mnt/user_data/user-config/config-deploy-devboard.yaml for a persistent user config containing only the diffs to the default config.</p></li>
<li><p>to stop automatic updates: rw; sudo systemctl disable ota-update.service</p></li>
<li><dl>
<dt>/mnt/user_data/etc/mosquitto/conf.d: here you can add additional config files for the mqtt broker. For example a “public_mqtt.conf” file with the following contents:</dt><dd><p><code class="docutils literal notranslate"><span class="pre">listener</span> <span class="pre">1883</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">allow_anonymous</span> <span class="pre">true</span></code> to allow anonymous external connections to the mqtt broker for debugging purposes</p>
</dd>
</dl>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">journalctl</span> <span class="pre">-fu</span> <span class="pre">everest.service</span></code>: watch the output of everest.service</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">journalctl</span> <span class="pre">-fu</span> <span class="pre">everest-dev.service</span></code>: watch the output of <code class="docutils literal notranslate"><span class="pre">everest-dev.service</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">/opt/everest/bin/manager</span> <span class="pre">--conf</span> <span class="pre">/opt/everest/conf/config-deploy-devboard.yaml</span></code>: run EVerest in the terminal. Make sure the systemd service is not running.</p></li>
</ul>
</section>
<section id="raspbian-partitioning-scheme">
<h3><span class="section-number">8.4.2. </span>Raspbian partitioning scheme<a class="headerlink" href="#raspbian-partitioning-scheme" title="Permalink to this heading">¶</a></h3>
<p>BelayBox uses a different partitioning scheme then vanilla raspian. The reason
for this is it supports A/B root partitions for updates. This way an update
can be downloaded and installed while the Box is in operation, even while
charging.</p>
<p>When rootfs A is booted, new updates will be installed to partition B and vice
versa. After succesfull installation an atomic flag is set in the Raspberry
Pi bootloader to try one boot of the newly installed system.</p>
<p>If it boots succesfully, the changes are made permanent. If not, it
automatically falls back to the previous version on the next boot.</p>
<p>The SD card has the following partitions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Device</span>         <span class="n">Boot</span>    <span class="n">Start</span>      <span class="n">End</span>  <span class="n">Sectors</span>  <span class="n">Size</span> <span class="n">Id</span> <span class="n">Type</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p1</span>          <span class="mi">8192</span>  <span class="mi">1056767</span>  <span class="mi">1048576</span>  <span class="mi">512</span><span class="n">M</span>  <span class="n">c</span> <span class="n">W95</span> <span class="n">FAT32</span> <span class="p">(</span><span class="n">LBA</span><span class="p">)</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p2</span>       <span class="mi">1056768</span> <span class="mi">14688255</span> <span class="mi">13631488</span>  <span class="mf">6.5</span><span class="n">G</span> <span class="mi">83</span> <span class="n">Linux</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p3</span>      <span class="mi">14688256</span> <span class="mi">28319743</span> <span class="mi">13631488</span>  <span class="mf">6.5</span><span class="n">G</span> <span class="mi">83</span> <span class="n">Linux</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p4</span>      <span class="mi">28319744</span> <span class="mi">30564351</span>  <span class="mi">2244608</span>  <span class="mf">1.1</span><span class="n">G</span>  <span class="n">f</span> <span class="n">W95</span> <span class="n">Ext</span><span class="s1">&#39;d (LBA)</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p5</span>      <span class="mi">28327936</span> <span class="mi">28459007</span>   <span class="mi">131072</span>   <span class="mi">64</span><span class="n">M</span> <span class="mi">83</span> <span class="n">Linux</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p6</span>      <span class="mi">28467200</span> <span class="mi">30564351</span>  <span class="mi">2097152</span>    <span class="mi">1</span><span class="n">G</span> <span class="mi">83</span> <span class="n">Linux</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">/dev/mmcblk0p1</span></code>: Boot partition.
This is used for both root partitions due to limitations
in the Raspberry Pi bootloader. It contains two subdirectories
(system0 and system1) with the boot files of the two installed root partitions.</p>
<p><code class="docutils literal notranslate"><span class="pre">/dev/mmcblk0p2</span></code>: Root partition A. Read only.</p>
<p><code class="docutils literal notranslate"><span class="pre">/dev/mmcblk0p3</span></code>: Root partition B. Read only.</p>
<p><code class="docutils literal notranslate"><span class="pre">/dev/mmcblk0p4</span></code>: Extented (container for 5-6)</p>
<p><code class="docutils literal notranslate"><span class="pre">/dev/mmcblk0p5</span></code>: Factory data.</p>
<p>The contents will be written once during production and should not be changed.
Mounted under <code class="docutils literal notranslate"><span class="pre">/mnt/factory_data</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">/dev/mmcblk0p6</span></code>: User data.
Only writable partition. All data generated during the use of the box will be
stored here. Also various configuration overrides can be set here, see Cheat
sheet.
Mounted under <code class="docutils literal notranslate"><span class="pre">/mnt/user_data</span></code>.</p>
</section>
<section id="using-online-updates">
<h3><span class="section-number">8.4.3. </span>Using online updates<a class="headerlink" href="#using-online-updates" title="Permalink to this heading">¶</a></h3>
<p>BelayBox comes with a very simple online update tool that is controlled by
two systemd services:</p>
<p><code class="docutils literal notranslate"><span class="pre">ota-update.service</span></code>: This service starts a shell script that checks for
online updates on Pionix update servers. It is triggered by the second systemd
service:</p>
<p><code class="docutils literal notranslate"><span class="pre">ota-update.timer</span></code>: This is the systemd timer unit that starts
<code class="docutils literal notranslate"><span class="pre">ota-update.service</span></code> on regular intervals.</p>
<p>To disable online updates use <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">disable</span> <span class="pre">ota-update.service</span></code>.
The online update updates always the full root partition. All data that needs
to survive the update needs to be stored in <code class="docutils literal notranslate"><span class="pre">/mnt/user_data</span></code>.</p>
<p>The root partition should normally never be modified, it is read only. All
changes will also be lost on the next online update.</p>
<p>If you still want to modify something, use the <code class="docutils literal notranslate"><span class="pre">rw</span></code> and <code class="docutils literal notranslate"><span class="pre">ro</span></code> commands
to re-mount root read-write/read-only.</p>
<p>In rw mode you can e.g. use <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt</span> <span class="pre">install</span> <span class="pre">...</span></code> to install new software.</p>
<p>Disable online update if you need the changes to stay.</p>
</section>
<section id="factory-reset">
<h3><span class="section-number">8.4.4. </span>Factory reset<a class="headerlink" href="#factory-reset" title="Permalink to this heading">¶</a></h3>
<p>For a factory reset of the BelayBox, the following partition has to be
formatted:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/mnt/user_data/
</pre></div>
</div>
<p>Before that, all services accessing that partition have to be stopped:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>everest
sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>nodered
</pre></div>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Depending of your setup, the EVerest service could also be called
<em>everest-dev</em> or <em>everest-rpi</em> instead of just <em>everest</em>.</p>
</div>
<p>After this, unmount the partition:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>umount<span class="w"> </span>/dev/mmcblk0p6
</pre></div>
</div>
<p>Finally, formatting can start:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>mkfs<span class="w"> </span>-t<span class="w"> </span>ext4<span class="w"> </span>/dev/mmcblk0p6
</pre></div>
</div>
<p>Confirm with “y” as soon as you are happy with losing all previous
configuation settings (e.g. WiFi credentials).</p>
<p>After formatting, reboot the BelayBox to let it setup the factory default
configuration:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>reboot
</pre></div>
</div>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../general/01_framework.html">1. EVerest framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../general/02_quick_start_guide.html">2. A Real Quick Guide To EVerest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../general/03_detail_pre_setup.html">3. Prepare Your Development Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../general/04_detail_module_concept.html">4. EVerest Module Concept</a></li>
<li class="toctree-l1"><a class="reference internal" href="../general/05_existing_modules.html">5. EVerest Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_tools/index.html">6. EVerest development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">7. Tutorials</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">8. Pionix BelayBox</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">8.1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-hardware-and-software">8.2. Setting up Hardware and Software</a></li>
<li class="toctree-l2"><a class="reference internal" href="#developing-with-everest-and-belaybox">8.3. Developing with EVerest and BelayBox</a></li>
<li class="toctree-l2"><a class="reference internal" href="#belaybox-further-information">8.4. BelayBox Further Information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/02_snapshot.html">9. Snapshot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/01_everest_reference/index.html">10. EVerest Reference</a></li>
</ul>

  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="../tutorials/sphinx_style_guide.html"
                          title="previous chapter"><span class="section-number">7.8. </span>Sphinx style guide</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="../appendix/02_snapshot.html"
                          title="next chapter"><span class="section-number">9. </span>Snapshot</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/hardware/pionix_belay_box.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div><h3>Community</h3>
<ul class="nav nav-sidebar">
<li><a href="https://lists.lfenergy.org/g/everest" target="_blank"><img src="../_static/icons/mail.svg" style="height: 0.8em" /> Get Support</a></li>
<li><a href="https://www.youtube.com/@lfe_everest" target="_blank"><img src="../_static/icons/youtube.svg" style="height: 0.8em" /> YouTube Channel</a></li>
<li><a href="https://twitter.com/everestincharge" target="_blank"><img src="../_static/icons/twitter.svg" style="height: 0.8em" /> Twitter</a></li>
<li><a href="https://fosstodon.org/@EVerest" target="_blank">Mastodon</a></li>
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../appendix/02_snapshot.html" title="9. Snapshot"
             >next</a> |</li>
        <li class="right" >
          <a href="../tutorials/sphinx_style_guide.html" title="7.8. Sphinx style guide"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">EVerest  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">8. </span>Pionix BelayBox</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Pionix GmbH.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.0.1.
    </div>
  </body>
</html>