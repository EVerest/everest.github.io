
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>6.4. How To: Simulate EVerest in software &#8212; EVerest  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinxdoc.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/contentui.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/contentui.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="6.5. Docker setup" href="../docker_setup.html" />
    <link rel="prev" title="6.3. How To: Develop New Modules" href="../new_modules/index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../docker_setup.html" title="6.5. Docker setup"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../new_modules/index.html" title="6.3. How To: Develop New Modules"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">EVerest  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U"><span class="section-number">6. </span>Tutorials</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">6.4. </span>How To: Simulate EVerest in software</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="how-to-simulate-everest-in-software">
<h1><span class="section-number">6.4. </span>How To: Simulate EVerest in software<a class="headerlink" href="#how-to-simulate-everest-in-software" title="Permalink to this heading">Â¶</a></h1>
<p>A successful <a class="reference external" href="https://github.com/EVerest/everest-core#ubuntu-2004">build</a> of everest is required.
First we need to run the docker container for <strong>mqtt</strong>, <strong>ocpp</strong>, <strong>nodered</strong> and <strong>steve</strong>.</p>
<p>(this can take a while on first run):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~/</span><span class="n">checkout</span><span class="o">/</span><span class="n">everest</span><span class="o">-</span><span class="n">workspace</span><span class="o">/</span><span class="n">everest</span><span class="o">-</span><span class="n">utils</span><span class="o">/</span><span class="n">docker</span>
<span class="n">sudo</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">up</span> <span class="o">-</span><span class="n">d</span>
</pre></div>
</div>
<p>To create the nodered dashboard, open a webbrowser of your choice and open the url:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">1880</span><span class="o">/</span>
</pre></div>
</div>
<p>This will open the nodered flowchart editor.</p>
<p>First we install the neccesary nodes.
Click on <em>Manage Palette</em> in the upper right corner menu:</p>
<img alt="../../_images/manage-palette.png" src="../../_images/manage-palette.png" />
<p>Make sure you have installed the following nodes by typing their names in the <em>Search modules</em> bar in the <em>Install section</em>:</p>
<img alt="../../_images/install-dashboard.png" src="../../_images/install-dashboard.png" />
<ul class="simple">
<li><p>node-red</p></li>
<li><p>node-red-contrib-ui-actions</p></li>
<li><p>node-red-contrib-ui-level</p></li>
<li><p>node-red-dashboard</p></li>
<li><p>node-red-node-ui-table</p></li>
</ul>
<p>Now we import the flow:
In the upper right corner menu select <em>IMPORT</em>:</p>
<img alt="../../_images/importflow.png" src="../../_images/importflow.png" />
<p>Copy the following flow into the empty field:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span>[{"id":"0ac94d2f2e51acfe","type":"tab","label":"Connector 1","disabled":false,"info":""},{"id":"a1cf7a0df2527a04","type":"group","z":"0ac94d2f2e51acfe","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["20fb089a9e2f11cf"],"x":1114,"y":439,"w":152,"h":82},{"id":"fd972550dc3a2dbf","type":"comment","z":"0ac94d2f2e51acfe","name":"Initialize the Connector number","info":"","x":230,"y":80,"wires":[]},{"id":"9f68c5b0589fc8c3","type":"change","z":"0ac94d2f2e51acfe","name":"","rules":[{"t":"set","p":"connector_number","pt":"flow","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":440,"y":140,"wires":[[]]},{"id":"185eb593bd68988c","type":"inject","z":"0ac94d2f2e51acfe","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payloadType":"date","x":190,"y":140,"wires":[["9f68c5b0589fc8c3"]]},{"id":"4f13fb19f621292c","type":"comment","z":"0ac94d2f2e51acfe","name":"Data to show","info":"","x":170,"y":200,"wires":[]},{"id":"6d43cf14cd928209","type":"mqtt out","z":"0ac94d2f2e51acfe","name":"","topic":"","qos":"1","retain":"false","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"fc8686af.48d178","x":890,"y":840,"wires":[]},{"id":"1046b12845f0b1d5","type":"ui_button","z":"0ac94d2f2e51acfe","name":"","group":"b364f7eb4621082b","order":1,"width":"3","height":"1","passthru":false,"label":"Pause","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"everest_external/nodered/#/cmd/pause_charging","topicType":"str","x":150,"y":700,"wires":[["318cd515277fbaa8"]]},{"id":"c2577573c0ef11a5","type":"ui_button","z":"0ac94d2f2e51acfe","name":"","group":"b364f7eb4621082b","order":2,"width":"3","height":"1","passthru":false,"label":"Resume","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"everest_external/nodered/#/cmd/resume_charging","topicType":"str","x":160,"y":760,"wires":[["318cd515277fbaa8"]]},{"id":"318cd515277fbaa8","type":"change","z":"0ac94d2f2e51acfe","name":"Insert Connector number","rules":[{"t":"change","p":"topic","pt":"msg","from":"#","fromt":"str","to":"connector_number","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":670,"y":840,"wires":[["6d43cf14cd928209","f1cc123140d082fb"]]},{"id":"08e4f0c3788fbd83","type":"comment","z":"0ac94d2f2e51acfe","name":"Commands","info":"","x":170,"y":640,"wires":[]},{"id":"7e07f13ee97ec92e","type":"mqtt in","z":"0ac94d2f2e51acfe","name":"","topic":"everest_external/nodered/+/state/max_current","qos":"2","datatype":"auto","broker":"fc8686af.48d178","nl":false,"rap":true,"rh":0,"inputs":0,"x":270,"y":280,"wires":[["7d9a27f7c49a415e"]]},{"id":"7d9a27f7c49a415e","type":"function","z":"0ac94d2f2e51acfe","name":"Filter connector number","func":"if (msg.topic.indexOf(String(flow.get('connector_number'))) > -1) return msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":280,"wires":[["00033ca9bcb05558"]]},{"id":"00033ca9bcb05558","type":"ui_text","z":"0ac94d2f2e51acfe","group":"b364f7eb4621082b","order":3,"width":0,"height":0,"name":"","label":"Max Current","format":"{{msg.payload | number: 1}}","layout":"row-spread","x":890,"y":280,"wires":[]},{"id":"95e26e8e46668517","type":"ui_text","z":"0ac94d2f2e51acfe","group":"b364f7eb4621082b","order":5,"width":0,"height":0,"name":"","label":"Energy Charged","format":"{{msg.payload | number:2}} kWh","layout":"row-spread","x":880,"y":340,"wires":[]},{"id":"d7da40bb09f007b9","type":"function","z":"0ac94d2f2e51acfe","name":"Filter connector number","func":"if (msg.topic.indexOf(String(flow.get('connector_number'))) > -1) return msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":340,"wires":[["95e26e8e46668517"]]},{"id":"030dcaa46ccd0bc3","type":"mqtt in","z":"0ac94d2f2e51acfe","name":"","topic":"everest_external/nodered/+/powermeter/totalKWattHr","qos":"2","datatype":"auto","broker":"fc8686af.48d178","nl":false,"rap":true,"rh":0,"inputs":0,"x":300,"y":340,"wires":[["d7da40bb09f007b9"]]},{"id":"61320d2443c1429e","type":"mqtt in","z":"0ac94d2f2e51acfe","name":"","topic":"everest_external/nodered/+/state/state_string","qos":"2","datatype":"auto","broker":"fc8686af.48d178","nl":false,"rap":true,"rh":0,"inputs":0,"x":270,"y":440,"wires":[["4fb9207354b6d87a"]]},{"id":"7b2a25dce5a5dd36","type":"mqtt in","z":"0ac94d2f2e51acfe","name":"","topic":"everest_external/nodered/+/powermeter/totalKw","qos":"2","datatype":"auto","broker":"fc8686af.48d178","nl":false,"rap":true,"rh":0,"inputs":0,"x":280,"y":500,"wires":[["ea13c30d045d2f27"]]},{"id":"5575cce655f6eb6e","type":"ui_level","z":"0ac94d2f2e51acfe","group":"b364f7eb4621082b","order":7,"width":0,"height":0,"name":"","label":"Temperature:","colorHi":"#e60000","colorWarn":"#ff9900","colorNormal":"#00b33c","colorOff":"#595959","min":"-20","max":"85","segWarn":"65","segHigh":"75","unit":"","layout":"sh","channelA":"","channelB":"","decimals":0,"animations":"soft","shape":"3","colorschema":"valuedriven","textoptions":"default","colorText":"#eeeeee","fontLabel":"","fontValue":"","fontSmall":"","colorFromTheme":true,"textAnimations":false,"hideValue":false,"tickmode":"segments","peakmode":false,"property":"payload","peaktime":3000,"x":1010,"y":560,"wires":[]},{"id":"0d330f8345032c52","type":"mqtt in","z":"0ac94d2f2e51acfe","name":"","topic":"everest_external/nodered/+/state/temperature","qos":"0","datatype":"auto","broker":"fc8686af.48d178","nl":false,"rap":true,"rh":0,"inputs":0,"x":280,"y":560,"wires":[["242e602beb4f1739"]]},{"id":"77da9e0729b00ac0","type":"function","z":"0ac94d2f2e51acfe","name":"","func":"if (msg.topic.indexOf('totalKw')>=0) {\n    context.data.totalKw = msg.payload;\n}\nelse if (msg.topic.indexOf('state_string')>=0) {\n    context.data.state_string = msg.payload;\n}\n\n//node.warn(msg.topic);\nmsg.payload = context.data.totalKw;\nmsg.label = context.data.state_string;\nreturn msg;","outputs":1,"noerr":0,"initialize":"// Code added here will be run once\n// whenever the node is started.\ncontext.data = {}","finalize":"","libs":[],"x":980,"y":480,"wires":[["0dee7e38aeb2483d","20fb089a9e2f11cf"]]},{"id":"0dee7e38aeb2483d","type":"debug","z":"0ac94d2f2e51acfe","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1190,"y":380,"wires":[]},{"id":"20fb089a9e2f11cf","type":"ui_gauge","z":"0ac94d2f2e51acfe","g":"a1cf7a0df2527a04","name":"","group":"b364f7eb4621082b","order":6,"width":0,"height":0,"gtype":"gage","title":"{{msg.label}}","label":"Kilowatt","format":"{{value}} kW","min":"0","max":"11","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":1190,"y":480,"wires":[]},{"id":"ea13c30d045d2f27","type":"function","z":"0ac94d2f2e51acfe","name":"Filter connector number","func":"if (msg.topic.indexOf(String(flow.get('connector_number'))) > -1) return msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":730,"y":500,"wires":[["77da9e0729b00ac0"]]},{"id":"4fb9207354b6d87a","type":"function","z":"0ac94d2f2e51acfe","name":"Filter connector number","func":"if (msg.topic.indexOf(String(flow.get('connector_number'))) > -1) return msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":730,"y":460,"wires":[["77da9e0729b00ac0"]]},{"id":"242e602beb4f1739","type":"function","z":"0ac94d2f2e51acfe","name":"Filter connector number","func":"if (msg.topic.indexOf(String(flow.get('connector_number'))) > -1) return msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":560,"wires":[["5575cce655f6eb6e"]]},{"id":"66bc82584321c869","type":"comment","z":"0ac94d2f2e51acfe","name":"Simulation control","info":"","x":190,"y":820,"wires":[]},{"id":"8422fb3402301607","type":"ui_switch","z":"0ac94d2f2e51acfe","name":"","label":"Simulation enable (HIL)","tooltip":"","group":"b364f7eb4621082b","order":10,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"everest_external/nodered/carsim/#/cmd/enable","topicType":"str","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":false,"x":210,"y":880,"wires":[["318cd515277fbaa8"]]},{"id":"c46d1f9a69e61448","type":"ui_button","z":"0ac94d2f2e51acfe","name":"","group":"b364f7eb4621082b","order":8,"width":"3","height":"1","passthru":false,"label":"Car Plugin","tooltip":"","color":"","bgcolor":"","icon":"","payload":"sleep 1;iec_wait_pwr_ready;sleep 1;draw_power_regulated 16,3;sleep 36000;unplug","payloadType":"str","topic":"everest_external/nodered/#/carsim/cmd/execute_charging_session","topicType":"str","x":170,"y":980,"wires":[["2876121042f4a76d"]]},{"id":"741c25a2451b735a","type":"ui_button","z":"0ac94d2f2e51acfe","name":"","group":"b364f7eb4621082b","order":9,"width":"3","height":"1","passthru":false,"label":"Car unplug","tooltip":"","color":"","bgcolor":"","icon":"","payload":"unplug","payloadType":"str","topic":"everest_external/nodered/#/carsim/cmd/modify_charging_session","topicType":"str","x":170,"y":940,"wires":[["318cd515277fbaa8"]]},{"id":"50ad1bd02690f998","type":"ui_slider","z":"0ac94d2f2e51acfe","name":"MaxCurrent Slider","label":"","tooltip":"","group":"b364f7eb4621082b","order":4,"width":0,"height":0,"passthru":false,"outs":"all","topic":"everest_external/nodered/#/cmd/set_max_current","topicType":"str","min":"6","max":"16","step":"0.1","x":450,"y":700,"wires":[["318cd515277fbaa8"]]},{"id":"4449f564a678c40e","type":"ui_dropdown","z":"0ac94d2f2e51acfe","name":"","label":"Simulation","tooltip":"","place":"Select option","group":"b364f7eb4621082b","order":10,"width":0,"height":0,"passthru":true,"multiple":false,"options":[{"label":"AC 3ph 16A","value":"sleep 1;iec_wait_pwr_ready;sleep 1;draw_power_regulated 16,3;sleep 36000;unplug","type":"str"},{"label":"AC 1ph 32A","value":"sleep 1;iec_wait_pwr_ready;sleep 1;draw_power_regulated 32,1;sleep 36000;unplug","type":"str"},{"label":"AC Diode Fail","value":"sleep 1;iec_wait_pwr_ready;sleep 1;draw_power_regulated 32,3;sleep 5;diode_fail;sleep 36000;unplug","type":"str"},{"label":"AC Error E","value":"sleep 1;iec_wait_pwr_ready;sleep 1;draw_power_regulated 16,3;sleep 3;error_e;sleep 36000;unplug","type":"str"},{"label":"AC RCD Error","value":"sleep 1;rcd_current 10.3;sleep 10;rcd_current 0.1;unplug","type":"str"},{"label":"AC ISO15118-2","value":"sleep 1;iso_wait_slac_matched;iso_start_v2g_session ExternalPayment,AC_three_phase_core;iso_wait_pwr_ready;iso_draw_power_regulated 16,3;sleep 36000#iso_stop_charging;iso_wait_v2g_session_stopped;unplug","type":"str"},{"label":"DC (experimental)","value":"sleep 1;iso_wait_slac_matched;iso_start_v2g_session ExternalPayment,DC_extended;sleep 36000#iso_stop_charging;iso_wait_v2g_session_stopped;unplug","type":"str"}],"payload":"","topic":"sim_commands","topicType":"str","x":170,"y":1040,"wires":[["2876121042f4a76d"]]},{"id":"2876121042f4a76d","type":"function","z":"0ac94d2f2e51acfe","name":"Buffer sim commands","func":"if (msg.topic.indexOf('sim_commands') > -1) {\n    flow.set('sim_commands', msg.payload);\n} else {\n    msg.payload = flow.get('sim_commands');\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":960,"wires":[["318cd515277fbaa8"]]},{"id":"f1cc123140d082fb","type":"debug","z":"0ac94d2f2e51acfe","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":910,"y":920,"wires":[]},{"id":"ded0b31b37892873","type":"inject","z":"0ac94d2f2e51acfe","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"1","topic":"sim_commands","payload":"sleep 1;iec_wait_pwr_ready;sleep 1;draw_power_regulated 16,3;sleep 36000;unplug","payloadType":"str","x":150,"y":1100,"wires":[["4449f564a678c40e"]]},{"id":"fc8686af.48d178","type":"mqtt-broker","name":"","broker":"localhost","port":"1883","clientid":"","autoConnect":true,"usetls":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willPayload":"","willMsg":{},"sessionExpiry":""},{"id":"b364f7eb4621082b","type":"ui_group","name":"Connector 1","tab":"d3ada9fa4cf6ac53","order":2,"disp":true,"width":"6","collapse":false},{"id":"d3ada9fa4cf6ac53","type":"ui_tab","name":"Home","icon":"dashboard","order":1,"disabled":false,"hidden":false}]</span>
</pre></div>
</div>
<p>Now deploy the flow:</p>
<img alt="../../_images/deployflow.png" src="../../_images/deployflow.png" />
<p>Run the Everest simulation with the following commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~/</span><span class="n">checkout</span><span class="o">/</span><span class="n">everest</span><span class="o">-</span><span class="n">workspace</span><span class="o">/</span><span class="n">everest</span><span class="o">-</span><span class="n">core</span><span class="o">/</span><span class="n">build</span><span class="o">/</span>
<span class="o">.././</span><span class="n">run_sil</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>To view the running dashboard, open a webbrowser of your choice and open:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">1880</span><span class="o">/</span><span class="n">ui</span>
</pre></div>
</div>
<p>There you can enable different simulations and watch the dashboard simulating charging funktions and failures.</p>
<img alt="../../_images/dashboard.png" src="../../_images/dashboard.png" />
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="../new_modules/index.html"
                          title="previous chapter"><span class="section-number">6.3. </span>How To: Develop New Modules</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="../docker_setup.html"
                          title="next chapter"><span class="section-number">6.5. </span>Docker setup</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/tutorials/run_sil/index.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../docker_setup.html" title="6.5. Docker setup"
             >next</a> |</li>
        <li class="right" >
          <a href="../new_modules/index.html" title="6.3. How To: Develop New Modules"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">EVerest  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" ><span class="section-number">6. </span>Tutorials</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">6.4. </span>How To: Simulate EVerest in software</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Pionix GmbH.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 6.1.3.
    </div>
  </body>
</html>