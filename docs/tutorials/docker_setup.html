
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>2.3. Docker setup &#8212; EVerest  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxdoc.css" />
    <link rel="stylesheet" type="text/css" href="../_static/contentui.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/contentui.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3. Tutorials" href="index.html" />
    <link rel="prev" title="2.2. ev-cli" href="../dev_tools/ev_cli.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="index.html" title="3. Tutorials"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../dev_tools/ev_cli.html" title="2.2. ev-cli"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">EVerest  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../dev_tools/index.html" accesskey="U"><span class="section-number">2. </span>EVerest development tools</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">2.3. </span>Docker setup</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="docker-setup">
<h1><span class="section-number">2.3. </span>Docker setup<a class="headerlink" href="#docker-setup" title="Permalink to this heading">¶</a></h1>
<p>You need to install <a class="reference external" href="https://docs.docker.com/engine/install/#server">docker</a> and <a class="reference external" href="https://docs.docker.com/compose/install/#install-compose)">docker-compose</a>.  Furthermore, <a class="reference external" href="https://code.visualstudio.com/docs/setup/linux">visual
studio code</a> might be handy as a common integrated development
environment.</p>
<p>In order for custom or local containers being able to talk to the
services, provided by the <em>docker-compose</em> containers, we need to create
a common docker network.  It is called <code class="docutils literal notranslate"><span class="pre">infranet_network</span></code> and needs to
be created by the following command (IPv6 is enabled for containers
which might it):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">network</span> <span class="n">create</span> <span class="o">--</span><span class="n">driver</span> <span class="n">bridge</span> <span class="o">--</span><span class="n">ipv6</span>  <span class="o">--</span><span class="n">subnet</span> <span class="n">fd00</span><span class="p">::</span><span class="o">/</span><span class="mi">80</span> <span class="n">infranet_network</span> <span class="o">--</span><span class="n">attachable</span>
</pre></div>
</div>
<p>Start <em>vscode</em>, open the workspace <em>docker-mqtt.code-workspace</em> and
install suggested extensions.  Open a shell in sub-directory <code class="docutils literal notranslate"><span class="pre">docker</span></code>
and run (might take while for the first run):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">up</span> <span class="o">-</span><span class="n">d</span>
</pre></div>
</div>
<p>Now, the following services should be running:</p>
<ul class="simple">
<li><p><strong>Mosquitto MQTT broker</strong> (service name: mqtt-server) with ports</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">1883</span></code>: mqtt tcp connection</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">9001</span></code>: mqtt websocket connection</p></li>
</ul>
</li>
<li><p><strong>mariadb</strong> (service name: ocpp-db), sql database needed by <strong>SteVe</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">3306</span></code>: sql tcp connection</p></li>
</ul>
</li>
<li><p><strong>SteVe</strong> (service name: steve) on port 8180 with endpoints</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">:8180/steve/manager/home</span></code>: web interface (login = admin:1234)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">:8180/steve/services/CentralSystemService</span></code>: SOAP endpoint for
OCPP</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">:8180/steve/websocket/CentralSystemService/(chargeBoxId)</span></code>:
WebSocket/JSON endpoint for OCPP</p></li>
</ul>
</li>
</ul>
<p>These three services are defined in <code class="docutils literal notranslate"><span class="pre">docker/docker-compose.yml</span></code> and
they live inside the docker network <code class="docutils literal notranslate"><span class="pre">docker_default</span></code> with their
respective ports.  By default these ports are not directly accessible by
using <code class="docutils literal notranslate"><span class="pre">localhost:8080</span></code> for example.  The current configuration exposes
all these ports to the local host with some port mapping, so the often
used ports will not clash with other services running already on your
host system.  The mapping is as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">1883</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">1883</span></code>, <code class="docutils literal notranslate"><span class="pre">9001</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">9001</span></code> for
<strong>mosquitto</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">13306</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">3306</span></code> for <strong>mariadb</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">8180</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">8180</span></code> for <strong>SteVe</strong></p></li>
</ul>
<p>So, if you want to access the <strong>mosquitto</strong> default mqtt port via your
local host, you need to access <code class="docutils literal notranslate"><span class="pre">localhost:1883</span></code>.  But if you want to
access it from a service or container inside the <em>docker_default</em>
network, you’ll need to access <code class="docutils literal notranslate"><span class="pre">mqtt-server:1883</span></code>. Using the docker
extension in <em>vscode</em>, you can show the logs of these services or attach
a shell to them by navigating to the docker tab and then right-clicking
on the specific container.</p>
<section id="everest-playground">
<h2><span class="section-number">2.3.1. </span>everest playground<a class="headerlink" href="#everest-playground" title="Permalink to this heading">¶</a></h2>
<p>depricated.</p>
<p>If you would like to get a pre-configured development setup using
<em>vscode</em> for the <em>everest-cpp</em> framework, you need to start up the mqtt
server with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">up</span> <span class="o">-</span><span class="n">d</span> <span class="n">mqtt</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
<p>Then, using <em>vscode</em>, open up a new window with <em>Ctrl+Shift+N</em> (or use
the current), press <em>F1</em>, enter <code class="docutils literal notranslate"><span class="pre">remopen</span></code>, select <cite>Remote-Containers:
Open Folder in Container…</cite>, head to the directory
<code class="docutils literal notranslate"><span class="pre">docker/everest-playground</span></code> and open. This will build a docker image
with a standard development environment and start <cite>vscode</cite>
inside it.  This image will also link to the <code class="docutils literal notranslate"><span class="pre">infranet_network</span></code> network,
so it can access the mqtt service and possible other services.</p>
<p>In order to build the <em>everest-cpp</em> framework, create a directory called
<code class="docutils literal notranslate"><span class="pre">build</span></code> and run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cmake</span> <span class="n">PATH_TO_EVEREST_CPP</span>
<span class="n">make</span> <span class="o">-</span><span class="n">j8</span>
</pre></div>
</div>
<p>inside it.</p>
</section>
<section id="local-ci-environment">
<h2><span class="section-number">2.3.2. </span>Local CI environment<a class="headerlink" href="#local-ci-environment" title="Permalink to this heading">¶</a></h2>
<p>depricated.</p>
<p>If you want to generate the sphinx documenation locally,  you can use
the <cite>ci-env</cite> docker image.  In order to build the image locally:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">docker</span><span class="o">/</span><span class="n">ci</span><span class="o">-</span><span class="n">env</span>
<span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">ci</span><span class="o">-</span><span class="n">env</span> <span class="o">.</span>
</pre></div>
</div>
<p>To generate the documentation, change to the project root and run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>docker run -it --rm -v `pwd`:/work ci-env
</pre></div>
</div>
<p>The documentation will be found in <code class="docutils literal notranslate"><span class="pre">docs/_build/html</span></code>.</p>
</section>
<section id="generating-languange-specific-protobuf-files">
<h2><span class="section-number">2.3.3. </span>Generating languange specific protobuf files<a class="headerlink" href="#generating-languange-specific-protobuf-files" title="Permalink to this heading">¶</a></h2>
<p>In order to create the protobuf implementation files for nanopb and
python, you can use the Dockerfile and scripts in
<code class="docutils literal notranslate"><span class="pre">docker/protobuf_generate</span></code>.  Change into that directory and then run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">run</span><span class="o">.</span><span class="n">sh</span> <span class="n">path_to_where_protobuf_files_reside</span>
</pre></div>
</div>
<p>This will</p>
<ol class="arabic simple">
<li><p>Build a docker image (including python and protoc)</p></li>
<li><p>Run the created image with the specified folder mounted into the container</p>
<ol class="arabic simple">
<li><p>Generate the language specific implementation files</p></li>
<li><p>Zip these files into <code class="docutils literal notranslate"><span class="pre">nanopb_pb_gen.zip</span></code> and``python_pb_gen.zip``</p></li>
</ol>
</li>
<li><p>Copy the zip files back to the host from the temporary container</p></li>
<li><p>Delete the container</p></li>
</ol>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">2.3. Docker setup</a><ul>
<li><a class="reference internal" href="#everest-playground">2.3.1. everest playground</a></li>
<li><a class="reference internal" href="#local-ci-environment">2.3.2. Local CI environment</a></li>
<li><a class="reference internal" href="#generating-languange-specific-protobuf-files">2.3.3. Generating languange specific protobuf files</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="../dev_tools/ev_cli.html"
                          title="previous chapter"><span class="section-number">2.2. </span>ev-cli</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="index.html"
                          title="next chapter"><span class="section-number">3. </span>Tutorials</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/tutorials/docker_setup.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="index.html" title="3. Tutorials"
             >next</a> |</li>
        <li class="right" >
          <a href="../dev_tools/ev_cli.html" title="2.2. ev-cli"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">EVerest  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../dev_tools/index.html" ><span class="section-number">2. </span>EVerest development tools</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">2.3. </span>Docker setup</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Pionix GmbH.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.1.1.
    </div>
  </body>
</html>